name: Publish Packages

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 0.1.1)'
        required: true

permissions:
  contents: write

env:
  VERSION: ${{ github.event.release.tag_name || inputs.version }}

jobs:
  # ============================================================
  # Build Flatpak
  # ============================================================
  flatpak:
    name: Build Flatpak
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Flatpak and Builder
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder
          flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          flatpak install -y flathub org.gnome.Platform//45 org.gnome.Sdk//45

      - name: Download .deb from release
        run: |
          VERSION_NUM=${VERSION#v}
          curl -L -o reclip-app.deb "https://github.com/${{ github.repository }}/releases/download/${VERSION}/reclip-app_${VERSION_NUM}_amd64.deb"

      - name: Update Flatpak manifest
        run: |
          VERSION_NUM=${VERSION#v}
          SHA256=$(sha256sum reclip-app.deb | cut -d' ' -f1)
          sed -i "s|VERSION|${VERSION}|g" flatpak/com.reclip.app.yml
          sed -i "s|PLACEHOLDER_SHA256|${SHA256}|g" flatpak/com.reclip.app.yml
          mv reclip-app.deb flatpak/reclip-app_${VERSION_NUM}_amd64.deb

      - name: Build Flatpak
        run: |
          cd flatpak
          flatpak-builder --force-clean --repo=repo build-dir com.reclip.app.yml
          flatpak build-bundle repo reclip-app.flatpak com.reclip.app

      - name: Upload Flatpak to release
        uses: softprops/action-gh-release@v1
        with:
          files: flatpak/reclip-app.flatpak
          tag_name: ${{ env.VERSION }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================
  # Build Snap
  # ============================================================
  snap:
    name: Build Snap
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download .deb from release
        run: |
          VERSION_NUM=${VERSION#v}
          curl -L -o snap/reclip-app_${VERSION_NUM}_amd64.deb "https://github.com/${{ github.repository }}/releases/download/${VERSION}/reclip-app_${VERSION_NUM}_amd64.deb"

      - name: Update snapcraft.yaml version
        run: |
          VERSION_NUM=${VERSION#v}
          sed -i "s|^version:.*|version: '${VERSION_NUM}'|g" snap/snapcraft.yaml

      - name: Build Snap
        uses: snapcore/action-build@v1
        id: snap-build
        with:
          path: snap

      - name: Upload Snap to release
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ steps.snap-build.outputs.snap }}
          tag_name: ${{ env.VERSION }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Optional: Publish to Snap Store (requires SNAPCRAFT_STORE_CREDENTIALS secret)
      # - name: Publish to Snap Store
      #   if: ${{ secrets.SNAPCRAFT_STORE_CREDENTIALS }}
      #   uses: snapcore/action-publish@v1
      #   env:
      #     SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT_STORE_CREDENTIALS }}
      #   with:
      #     snap: ${{ steps.snap-build.outputs.snap }}
      #     release: stable
